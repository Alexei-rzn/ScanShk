<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сканирование штрих-кода</title>
    <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
    <style>
        #scanner-container {
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
        }
        video {
            width: 100%;
        }
        #result {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Сканирование штрих-кода</h1>
    
    <label for="columns-select">Выберите столбцы для отображения:</label>
    <select id="columns-select" multiple>
        <option value="name">Название товара</option>
        <option value="price">Цена</option>
        <option value="description">Описание</option>
    </select>

    <br><br>
    <button id="scan-button">Сканировать</button>
    <button id="reset-button">Сброс</button>

    <div id="scanner-container"></div>
    <div id="result">
        <p>Результат: <span id="barcode-result">—</span></p>
    </div>
    <div id="data-table">
        <table>
            <thead>
                <tr id="table-header">
                    <!-- Заголовки выбранных колонок -->
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Данные из таблицы будут отображаться здесь -->
            </tbody>
        </table>
    </div>

    <script>
        // Функция для поиска данных по штрих-коду в Google Sheets
        async function fetchGoogleSheetData(barcode) {
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3oeQ768KbbMYrfrrijNYswWat4GdsDzAa7iRZZ2vLqjvg6zbTQ5Efe1LFn9wRfULaghfYoRGruy1w/pub?output=csv';
            const response = await fetch(sheetUrl);
            const data = await response.text();
            const rows = data.split('\n').map(row => row.split(','));
            
            // Ищем строку, где штрих-код совпадает
            const foundRow = rows.find(row => row.includes(barcode));

            if (foundRow) {
                return {
                    name: foundRow[0], // Название товара (пример)
                    price: foundRow[1], // Цена (пример)
                    description: foundRow[2] // Описание (пример)
                };
            } else {
                return null;
            }
        }

        // Функция для отображения данных в таблице
        function displayData(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // Очищаем таблицу

            const selectedColumns = Array.from(document.getElementById('columns-select').selectedOptions).map(option => option.value);
            
            if (data) {
                const row = document.createElement('tr');
                selectedColumns.forEach(column => {
                    const cell = document.createElement('td');
                    cell.innerText = data[column];
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = selectedColumns.length;
                cell.innerText = "Штрих-код не найден";
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }

        // Функция для обновления заголовков таблицы
        function updateTableHeaders() {
            const tableHeader = document.getElementById('table-header');
            tableHeader.innerHTML = ''; // Очищаем заголовки

            const selectedColumns = Array.from(document.getElementById('columns-select').selectedOptions).map(option => option.text);
            selectedColumns.forEach(column => {
                const header = document.createElement('th');
                header.innerText = column;
                tableHeader.appendChild(header);
            });
        }

        // Функция запуска камеры и сканера
        function startScanner() {
            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'), // Вставляем поток видео в контейнер
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Используем заднюю камеру
                    },
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "code_39_reader"] // Типы штрих-кодов для распознавания
                }
            }, function (err) {
                if (err) {
                    console.log(err);
                    return;
                }
                console.log("Scanner initialized");
                Quagga.start(); // Запускаем сканер
            });

            Quagga.onDetected(async function (data) {
                const barcode = data.codeResult.code;
                document.getElementById("barcode-result").innerText = barcode; // Выводим результат
                console.log("Код штрих-кода: ", barcode);

                // Останавливаем сканер после успешного сканирования
                Quagga.stop();
                
                // Ищем данные в Google Sheets по штрих-коду
                const resultData = await fetchGoogleSheetData(barcode);
                displayData(resultData); // Отображаем данные в таблице
            });
        }

        // Функция для сброса результатов
        function resetScanner() {
            document.getElementById("barcode-result").innerText = '—';
            document.getElementById("table-body").innerHTML = ''; // Очищаем таблицу
            document.getElementById("table-header").innerHTML = ''; // Очищаем заголовки
        }

        // Запуск сканера по нажатию кнопки
        document.getElementById('scan-button').addEventListener('click', function() {
            updateTableHeaders(); // Обновляем заголовки перед сканированием
            startScanner();
        });

        // Сброс по нажатию кнопки
        document.getElementById('reset-button').addEventListener('click', function() {
            resetScanner();
        });
    </script>
</body>
</html>
